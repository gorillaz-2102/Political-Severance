<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Créer son Gouvernement</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f6f6f6;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      margin: 30px 0;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }

    #fonctions, #fonctions-ministeres {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .fonction {
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      width: 250px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .fonction.large {
      width: 100%;
    }

    .info {
      margin-bottom: 10px;
    }

    .titre {
      font-weight: bold;
      margin-bottom: 8px;
    }

    input[type="text"] {
      padding: 6px;
      width: 100%;
      margin-bottom: 6px;
    }

    button {
      padding: 6px 12px;
      margin-top: 6px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:disabled {
      background-color: #ccc;
    }

    .image-zone {
      width: 100%;
      height: 180px;
      background-color: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      overflow: hidden;
    }

    .image-zone img {
      max-width: 100%;
      max-height: 100%;
    }

    table {
      width: 90%;
      margin: 30px auto;
      border-collapse: collapse;
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #f1f1f1;
    }

    .nom-personne {
      display: block;
      margin-top: 4px;
      color: #007BFF;
      text-decoration: none;
    }

    .nom-personne:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>Crée ton propre gouvernement</h1>

  <div class="container">
    <div id="fonctions"></div>
    <hr style="margin: 40px 0;">
    <div id="fonctions-ministeres"></div>
  </div>

  <script>
  const fonctions = [
    { nom: "Président de la République", personne: null },
    { nom: "Premier Ministre", personne: null },
    { nom: "Intérieur", personne: null },
    { nom: "Transition écologique et solidaire", personne: null },
    { nom: "Justice", personne: null },
    { nom: "Europe et aff. étrangères", personne: null },
    { nom: "Armées", personne: null },
    { nom: "Cohésion des territoires", personne: null },
    { nom: "Solidarités & Santé", personne: null },
    { nom: "Economie & Finances", personne: null },
    { nom: "Culture", personne: null },
    { nom: "Travail", personne: null },
    { nom: "Education Nationale", personne: null },
    { nom: "Agriculture & Alimentation", personne: null },
    { nom: "Action & Comptes Publics", personne: null },
    { nom: "Enseignement Sup., Recherche & Innov.", personne: null },
    { nom: "Outre-mer", personne: null },
    { nom: "Sports", personne: null },
    { nom: "Secrétariat d'État Egalité H/F", personne: null },
  ];

  function afficherFonctions() {
    const containerTop = document.getElementById('fonctions');
    const containerBottom = document.getElementById('fonctions-ministeres');
    containerTop.innerHTML = '';
    containerBottom.innerHTML = '';

    fonctions.forEach((f, index) => {
      const div = document.createElement('div');
      div.className = 'fonction';
      div.classList.add(index < 2 ? 'large' : 'small');

      const infoDiv = document.createElement('div');
      infoDiv.className = 'info';

      const titre = document.createElement('div');
      titre.className = 'titre';
      titre.textContent = f.nom;
      infoDiv.appendChild(titre);

      const imageDiv = document.createElement('div');
      imageDiv.className = 'image-zone';

      if (f.personne) {
        const wikiUrl = `https://fr.wikipedia.org/wiki/${encodeURIComponent(f.personne.nom.replace(/ /g, "_"))}`;
        const nomLink = document.createElement('a');
        nomLink.className = 'nom-personne';
        nomLink.href = wikiUrl;
        nomLink.target = "_blank";
        nomLink.textContent = f.personne.nom;
        infoDiv.appendChild(nomLink);

        const boutonChanger = document.createElement('button');
        boutonChanger.textContent = "Changer";
        boutonChanger.onclick = () => {
          f.personne = null;
          afficherFonctions();
        };
        infoDiv.appendChild(boutonChanger);

        if (f.personne.image) {
          const img = document.createElement('img');
          img.src = f.personne.image;
          img.alt = f.personne.nom;
          img.onload = () => imageDiv.classList.add('loaded');
          imageDiv.innerHTML = "";
          imageDiv.appendChild(img);
        } else {
          imageDiv.innerHTML = "<span>?</span>";
        }
      } else {
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = "Ajouter un nom";
        input.autocomplete = "off";

        const boutonRecruter = document.createElement('button');
        boutonRecruter.textContent = "Choisir";
        boutonRecruter.disabled = true;

        const suggestions = document.getElementById('suggestions');

        input.addEventListener("input", async () => {
          const query = input.value.trim();
          suggestions.innerHTML = "";
          boutonRecruter.disabled = true;
          if (query.length < 2) return;

          async function rechercherWiki(lang, query) {
            const res = await fetch(`https://${lang}.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=pageimages|pageprops&piprop=thumbnail&pithumbsize=100&generator=prefixsearch&gpssearch=${encodeURIComponent(query)}&gpslimit=5`);
            const data = await res.json();
            return data.query ? Object.values(data.query.pages) : [];
          }

          async function chercherImageWikidata(qid) {
            const res = await fetch(`https://www.wikidata.org/wiki/Special:EntityData/${qid}.json`);
            const data = await res.json();
            const claims = data.entities[qid].claims;
            const imageClaim = claims && claims.P18 ? claims.P18[0].mainsnak.datavalue.value : null;

            if (imageClaim) {
              const filename = imageClaim.replace(/ /g, '_');
              const md5 = await crypto.subtle.digest('MD5', new TextEncoder().encode(filename));
              const hashArray = Array.from(new Uint8Array(md5)).map(b => b.toString(16).padStart(2, '0'));
              const hash = hashArray.join('');
              return `https://upload.wikimedia.org/wikipedia/commons/${hash[0]}/${hash.slice(0,2)}/${filename}`;
            }
            return null;
          }

          const allPages = await rechercherWiki("fr", query);
          const pages = allPages.length > 0 ? allPages : await rechercherWiki("en", query);

          for (const page of pages) {
            const li = document.createElement("li");
            const span = document.createElement("span");
            span.textContent = page.title;

            let imgSrc = page.thumbnail ? page.thumbnail.source : "";

            if (!imgSrc || imgSrc.includes("No_image") || imgSrc.includes("Image_not_available")) {
              const qid = page.pageprops ? page.pageprops.wikibase_item : null;
              if (qid) {
                imgSrc = await chercherImageWikidata(qid) || "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6c/No_image_3x4.svg/50px-No_image_3x4.svg.png";
              }
            }

            const img = document.createElement("img");
            img.src = imgSrc;
            img.alt = "";
            img.style.width = "30px";
            img.style.height = "30px";
            img.style.objectFit = "cover";
            img.style.borderRadius = "50%";
            img.style.marginRight = "10px";

            li.appendChild(img);
            li.appendChild(span);

            li.onclick = () => {
              f.personne = {
                nom: page.title,
                image: img.src
              };
              suggestions.innerHTML = "";
              afficherFonctions();
            };

            suggestions.appendChild(li);
          }

          const rect = input.getBoundingClientRect();
          suggestions.style.left = rect.left + "px";
          suggestions.style.top = (window.scrollY + rect.bottom) + "px";
          suggestions.style.width = rect.width + "px";
        });

        document.addEventListener("click", (e) => {
          if (!suggestions.contains(e.target) && e.target !== input) {
            suggestions.innerHTML = "";
          }
        });

        infoDiv.appendChild(input);
        infoDiv.appendChild(boutonRecruter);
        imageDiv.innerHTML = "<span>?</span>";
      }

      div.appendChild(infoDiv);
      div.appendChild(imageDiv);

      if (index < 2) {
        containerTop.appendChild(div);
      } else {
        containerBottom.appendChild(div);
      }
    });

    // Ajouter bouton valider s'il n'existe pas
    if (!document.getElementById("btn-valider")) {
      const btn = document.createElement("button");
      btn.id = "btn-valider";
      btn.textContent = "Valider le gouvernement";
      btn.style.display = "block";
      btn.style.margin = "30px auto";
      btn.onclick = afficherDoublons;
      document.body.appendChild(btn);
    }
  }

  function afficherDoublons() {
    // Nettoyer ancien tableau
    const ancienTableau = document.getElementById("tableau-doublons");
    if (ancienTableau) ancienTableau.remove();

    const map = new Map();

    fonctions.forEach(f => {
      if (f.personne) {
        const nom = f.personne.nom;
        if (!map.has(nom)) map.set(nom, []);
        map.get(nom).push(f.nom);
      }
    });

    const doublons = [...map.entries()].filter(([_, postes]) => postes.length > 1);
    if (doublons.length === 0) return;

    const table = document.createElement("table");
    table.id = "tableau-doublons";

    const thead = table.createTHead();
    const headerRow = thead.insertRow();
    ["Nom", "Postes"].forEach(texte => {
      const th = document.createElement("th");
      th.textContent = texte;
      headerRow.appendChild(th);
    });

    const tbody = table.createTBody();

    doublons.forEach(([nom, postes]) => {
      const row = tbody.insertRow();
      const cellNom = row.insertCell();
      cellNom.textContent = nom;

      const cellPostes = row.insertCell();
      cellPostes.textContent = postes.join(", ");
    });

    document.body.appendChild(table);
  }

  afficherFonctions();

</script>
</body>
</html>
